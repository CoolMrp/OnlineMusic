<!-- <%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %> -->
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<link rel="shortcut icon" type="images/x-icon" href="images/title.ico">
<title>æ­Œæ›²è¯„è®º</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link href="css/common.css" rel="stylesheet">
<link href="css/comment.css" rel="stylesheet">
<link href="css/iconfont.css" rel="stylesheet">
<script src="js/adaptation.js"></script>
<script src="js/lyric.js"></script>
<script src="js/jquery-1.11.3.min.js" type="text/javascript"></script>
</head>
<body>
    <div id="main">
      <div class="header">
        <span style="position:absolute;left:10px;" onclick="back()"><i class="iconfont icon-fanhui1" style="font-size:20px;"></i></span>
        <p class="title">æ­Œæ›²è¯„è®ºï¼ˆ0ï¼‰</p>
      </div>
      <div class="box">
        <div class="song">
          <div class="pic">
            <img id="album" src="" alt="ä¸“è¾‘"/>
          </div>
          <div class="singer">
            <!-- <p>å¿ƒå¦‚æ­¢æ°´</p>
            <p>coolmrp</p> -->
          </div>
        </div>
        <div class="content">
          <p class="tip">å°å¯çˆ±ï¼Œæ­Œæ›²æš‚æ— è¯„è®ºï¼Œå ä¸ªåº§å†èµ°å‘—ğŸ˜Š</p>
          <ul class="list">
            <!-- <li>
              <p class="commentator">
                <img src="./images/homeBg.jpg" alt="img" />
                <span class="user">
                  <i style="font-size:14px;">æ¸…é£çƒŸé›¨</i>
                  <i style="font-size:12px;color:#666">3æœˆ15æ—¥</i>
                </span>
                <span class="fabulous">21.7ä¸‡<i class="iconfont icon-zan2" style="font-size:20px;" id="1"></i></span>
              </p>
              <p style="margin:10px 0 10px 35px;padding: 10px 0;border-bottom:1px solid #ddd;">è¿™æ­Œä¹Ÿå¤ªå¥½å¬äº†ä½ å‘€ï¼Œå¿ƒå¦‚æ­¢æ°´ï¼Œå†æ— æ³¢åŠ¨ï¼ï¼ï¼</p>
            </li> -->
          </ul>
        </div>
        <!-- <div class="comment_input">
          <form action="" method="post">
            <input id="inputText" type="text" placeholder="éšä¹è€Œèµ·ï¼Œæœ‰æ„Ÿè€Œå‘" />
            <input type="button" value="å‘é€" onclick="sendComment()"/>
          </form>
        </div> -->
      </div>
      <div class="comment_input">
          <form action="" method="post">
            <input id="inputText" type="text" placeholder="éšä¹è€Œèµ·ï¼Œæœ‰æ„Ÿè€Œå‘" />
            <input type="button" value="å‘é€" onclick="sendComment()"/>
          </form>
        </div>
      <div class="alertTip"></div>
      <div class="alert">
	      	<p class="text">æ€ä¹ˆä¸ç™»å½•å°±è¿›æ¥äº†å‘¢ï¼Œèµ¶å¿«å»ç™»å½•ï¼Œä¹–ğŸ˜Šï½ï½ï½</p>
	      	<p class="btn" onclick="window.location.href='./login.html'">å»ç™»å½•</p>
      </div>
    </div>
    <script>
      var praiseNum; // ç‚¹èµæ•°é‡
      var fabulousId = []; // å­˜æ”¾è¯„è®ºåˆ—è¡¨id
      var tip = getClass("alertTip")[0];
      init();
      function init() { // åˆå§‹åŒ–
    	  if (!getCookie("uid")){
    		  $(".alert").show("slow");
    	  }
    	  var sid = window.location.search.split("=")[1];
    	  $.ajax({
				"async": false,
				"url": "/music/getSongComment",
				"data": {"sid": sid,"method": "songComment"},
				"type": "POST",
				"dataType": "json",
				"success": function (data) {
					console.log(data);
					callback(data,sid);
				},
				"error":function(xhr, status, errMsg){
		            console.log("é”™è¯¯:"+errMsg);
		        }
			})
      }
      // æˆåŠŸå›è°ƒå‡½æ•°
      function callback (data,sid){
    	  var album = document.getElementById("album");
    	  var songBox = getClass("singer")[0];
    	  var title = getClass("title")[0];
    	  var list = getClass("list")[0];
    	  album.src = lrc[parseInt(sid)].album;
    	  var str = "<p>"+lrc[parseInt(sid)].songName+"</p><p>"+lrc[parseInt(sid)].singer+"</p>";
    	  songBox.innerHTML = str;
    	  if (data.length > 0) {
    		  title.innerText = "æ­Œæ›²è¯„è®ºï¼ˆ"+data.length+"ï¼‰";
    		  $(".tip").text("ç²¾å½©è¯„è®º");
    		  $(".tip").css({"color":"#000","text-align":"left"});
    		  list.innerHTML = ""; // æ¸…ç©ºåˆ—è¡¨
    		  fabulousId = [];  // æ¸…ç©ºæ•°ç»„
        	  for (var i=0,len=data.length;i<len;i++) {
        		  fabulousId.push(data[i].fabulousId);
        		  var commentList = '<li><p class="commentator"><img src="'+data[i].portrait+'" alt="img" /><span class="user"><i style="font-size:14px;">'+data[i].username+'</i><i style="font-size:12px;color:#666">'+data[i].commentDate+'</i></span><span class="fabulous"><i>'+data[i].praiseNum+'</i><i class="praise iconfont icon-zan2" style="font-size:20px;" onclick="fabulous('+i+')"></i></span></p><p style="margin-left: 35px;padding: 10px 0;border-bottom:1px solid #ddd;color:#09c">'+data[i].comtent+'</p></li>';
            	  list.innerHTML += commentList;
            	  praiseNum = document.getElementsByClassName("praise");
        	  }
    	  }
      }
      // ç‚¹èµ
      function fabulous(i){
		$.ajax({
			"async": false,
			"url": "/music/fabulous",
			"data": {"fabulousId":fabulousId[i].toString(),"praiseNum": praiseNum[i].parentNode.children[0].innerText},
			"type": "POST",
			"dataType": "json",
			"success": function (data) {
				console.log(data.flag);
				/* var tip = getClass("alertTip")[0]; */
				if (data.flag) {
					if (praiseNum[i].classList.contains("red")) {
						praiseNum[i].classList.remove("red");
						praiseNum[i].parentNode.children[0].innerText = parseInt(praiseNum[i].parentNode.children[0].innerText) - 1
					} else {
						praiseNum[i].classList.add("red");
						praiseNum[i].parentNode.children[0].innerText = parseInt(praiseNum[i].parentNode.children[0].innerText) + 1
					}
				} else {
					tip.innerText = "ç‚¹èµå¤±è´¥,ç½‘ç»œå¼€å°å·®å•¦ğŸ˜¢";
					tip.style.height = "45px";
					setTimeout(function(){tip.style.height = "0px";},2000);
				} 
			},
			"error":function(xhr, status, errMsg){
	            console.log("é”™è¯¯:"+errMsg);
	        }
		})
      };
      // å‘é€è¯„è®º
      function sendComment (value) {
    	  var sid = window.location.search.split("=")[1];
    	  var input = document.getElementById("inputText");
    	  var text = input.value.trim();
    	  var userName = getCookie("userName");
    	  var uid = getCookie("uid");
    	  var portrait;
    	  var date = new Date().toLocaleDateString();
    	  var commentDate = date.split("/")[0]+"å¹´"+date.split("/")[1]+"æœˆ"+date.split("/")[2]+"æ—¥";
    	  if (text === "") {
    		  /* alert("è¯·è¾“å…¥å†…å®¹ååœ¨è¿›è¡Œå‘é€"); */
    		  tip.innerText = "è¯·è¾“å…¥å†…å®¹ååœ¨è¿›è¡Œå‘é€";
			  tip.style.height = "45px";
			  setTimeout(function(){tip.style.height = "0px";},2000);
    		  input.focus();
    	  } else {
    		  console.log(text);
    		  $.ajax({
  				"async": false,
  				"url": "/music/getUserInfo",
  				"data": {"userName":userName},
  				"type": "POST",
  				"dataType": "json",
  				"success": function (data) {
  					console.log(data);
  					portrait = data.portrait;
  				},
  				"error":function(xhr, status, errMsg){
  		            console.log("é”™è¯¯:"+errMsg);
  		        }
  			})
    		  $.ajax({
  				"async": false,
  				"url": "/music/insertComment",
  				"data": {"sid": sid,"username":userName,"comtent":text,"praiseNum":0,"commentDate":commentDate,"portrait":portrait,"uid":uid},
  				"type": "POST",
  				"dataType": "json",
  				"success": function (data) {
  					console.log("è¿”å›æ•°æ®ï¼š",data);
  					var tip = getClass("alertTip")[0];
  					if (data.flag) {
  						init(); // é‡æ–°åˆå§‹åŒ–
  						input.value = "";
  						tip.innerText = "è¯„è®ºæˆåŠŸğŸ˜Š";
  						tip.style.height = "45px";
  						setTimeout(function(){tip.style.height = "0px";},2000);
  					} else {
  						tip.innerText = "è¯„è®ºå¤±è´¥ğŸ˜«,è¯·ç¨åé‡è¯•";
  						tip.style.height = "45px";
  						setTimeout(function(){tip.style.height = "0px";},2000);
  					}
  				},
  				"error":function(xhr, status, errMsg){
  		            console.log("é”™è¯¯:"+errMsg);
  		        }
  			})
    	  }
      }
      // è¿”å›
      function back () {
    	  var sid = window.location.search.split("=")[1];
    	  if (sid) {
    		  window.location.href = "./play.html?sid="+ sid;
    	  } else {
    		  window.location.href = "./play.html";
    	  }
    	  
      } 
    	//è·å–ç±»å
        function getClass(cName){
          if(window.getElementsByClassName){
            return document.getElementsByClassName("cName");
          }else{
            var arr = [];
            var all = document.getElementsByTagName("*");
            for(var i=0;i<all.length;i++){
              if(cName==all[i].className){
                arr.push(all[i]);
              }
            }
            return arr;
          }
        }
   		// è·å–cookie
		function getCookie(key){
			var cookie = document.cookie;
			var reg = new RegExp("(\\s|^)"+key+"=([^;]*)(;|$)");
			var s = cookie.match(reg);
			return s?s[2]:"";
		}
    </script>
</body>
</html>






