<!-- <%-- <%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%> --%> -->
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="shortcut icon" type="images/x-icon" href="images/title.ico">
<title>æˆ‘çš„èµ„æ–™</title>
<link href="css/common.css" rel="stylesheet">
<link href="css/information.css" rel="stylesheet">
<link href="css/iconfont.css" rel="stylesheet">
<script src="js/adaptation.js"></script>
<script src="js/lyric.js"></script>
<script src="js/jquery-1.11.3.min.js" type="text/javascript"></script>
</head>
<body>
	<div class="main">
		<div class="header">
	       <span style="position:absolute;left:10px;" onclick="back()"><i class="iconfont icon-fanhui1" style="font-size:20px;"></i></span>
	       <p class="title">åŸºæœ¬èµ„æ–™</p>
	    </div>
	    <div class="box">
    		<ul class=list>
    			<li class="pic">
    				<p><img alt="" src="" class="portrait"></p>
    			</li>
    			<li>
    				<span>ç”¨æˆ·åï¼š<i contenteditable=false class="username"></i></span>
    				<span class="btn" onclick="modify(this,'username')">ä¿®æ”¹</span>
    			</li>
    			<li>
    				<span>ç”µè¯ï¼š<i class="telephone"></i></span>
    				<span class="btn" onclick="modify(this,'telephone')">ä¿®æ”¹</span>
    			</li>
    			<li>
    				<span>qqï¼š<i class="qq"></i></span>
    				<span class="btn" onclick="modify(this,'qq')">ä¿®æ”¹</span>
    			</li>
    			<li>
    				<span>é‚®ç®±ï¼š<i class="email"></i></span>
    				<span class="btn" onclick="modify(this,'email')">ä¿®æ”¹</span>
    			</li>
    			
    		</ul>
    		<div class="password_box">
    			<div class="modify">
	    			<p><span>æ—§å¯†ç ï¼š</span><input type="password" class="old" placeholder="è¯·è¾“å…¥å°±å¯†ç " /></p>
	    			<p><span>æ–°å¯†ç ï¼š</span><input type="password" class="new" placeholder="è¯·è¾“å…¥æ–°å¯†ç " /></p>
	    			<div>
	    				<p class="submit">ç¡®è®¤</p>
	    				<p class="cancle">å–æ¶ˆ</p>
	    			</div>
	    		</div>
    		</div>
    		<div class="btn_box">
    			<p class="updatePassword">ä¿®æ”¹å¯†ç </p>
    			<p><a href="./portrait.html" style="display:block;width:100%;height:100%;color:#fff;">è®¾ç½®å¤´åƒ</a></p>
    			<p class="updatePassword" onclick="window.location.href='/music/loginOut'">é€€å‡ºç™»å½•</p>
    		</div>
	    </div>
	    <div class="alertTip"></div>
	    <div class="alert">
	      	<p class="text">æ€ä¹ˆä¸ç™»å½•å°±è¿›æ¥äº†å‘¢ï¼Œèµ¶å¿«å»ç™»å½•ï¼Œä¹–ğŸ˜Šï½ï½ï½</p>
	      	<p class="btn" onclick="window.location.href='./login.html'">å»ç™»å½•</p>
      	</div>
	</div>
	<script type="text/javascript">
		function modify(This,attr){
			var textNode = This.parentNode.children[0].children[0];
			var reg = {
		            qq : /^[1-9]\d{4,10}$/,
		            telephone : /^1[3-9]\d{9}$/,
		            username : /^[a-z]\w{5,15}$/i,
		            password : /^[\w~!@#$%^&*()+{}[\]:"|',.?\-/]{6,16}$/,
		            email : /^[1-9a-z]\w+@[0-9a-z\-]{2,}(\.[a-z]{2,}){1,2}$/i
		        };
			if (This.innerText === "ä¿®æ”¹") {
				This.innerText = "ç¡®å®š";
				$(This).addClass("red");
				textNode.setAttribute("contenteditable",true);
				console.log(textNode.innerText);
			} else {
				This.innerText = "ä¿®æ”¹";
				$(This).removeClass("red");
				textNode.setAttribute("contenteditable",false);
				var text = textNode.innerText.trim();
				console.log(text);
				if (text){
					if (reg[attr].test(text)) {
						modifyRequest(attr,text);
					} else {
						$(".alertTip").text(attr+"è¾“å…¥ä¸åˆæ³•");
						$(".alertTip").show(function(){
							setTimeout(function(){
								$(".alertTip").hide();
							},1000);
						});
						init();  // é‡æ–°è·å–æ•°æ®
					}
				} else {
					$(".alertTip").text(attr+"ä¸èƒ½è®¾ç½®ä¸ºç©º");
					$(".alertTip").show(function(){
						setTimeout(function(){
							$(".alertTip").hide();
						},1000);
					});
					init();  // é‡æ–°è·å–æ•°æ®
				}
			}
		}
		// ä¿®æ”¹æ•°æ®è¯·æ±‚
		function modifyRequest (attr,text) {
			var uid = getCookie("uid");
			$.ajax({
				"async": false,
				"url": "/music/updateUserinfo",
				"data": {"uid":uid,"attribute":attr,"newValue":text},
				"type": "POST",
				"success": function (data) {
					console.log(data);
					if (data === "true") {
						$(".alertTip").text("ä¿®æ”¹æˆåŠŸğŸ˜Š");
						$(".alertTip").show(function(){
							setTimeout(function(){
								$(".alertTip").hide();
							},1000);
						});
						$(".password_box").hide("slow");
					} else if (data === "false"){
						$(".alertTip").text("ä¿®æ”¹å¤±è´¥ï¼Œéš¾è¿‡ğŸ˜«");
						$(".alertTip").show(function(){
							setTimeout(function(){
								$(".alertTip").hide();
							},1000);
						});
						$(".password_box").hide("slow");
					} else if (data === "ä½ çš„æ—§å¯†ç è¾“å…¥é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥") {
						$(".alertTip").text("æ—§å¯†ç é”™è¯¯ï¼Œç»†å¿ƒç‚¹å§ğŸ˜");
						$(".alertTip").show(function(){
							setTimeout(function(){
								$(".alertTip").hide();
							},1000);
						});
					}
					init();  // é‡æ–°è·å–æ•°æ®
				},
				"error":function(xhr, status, errMsg){
		            console.log("é”™è¯¯:"+errMsg);
		        }
			})
		}
		init();
		function init () {
			var userName = getCookie("userName");
			console.log("åˆå§‹åŒ–:"+userName);
			if (userName) {
				$.ajax({
					"async": false,
					"url": "/music/getUserInfo",
					"data": {"userName":userName},
					"type": "POST",
					"dataType": "json",
					"success": function (data) {
						console.log(data);
						$(".portrait").attr("src",data.portrait);
						$(".username").text(data.username);
						$(".telephone").text(data.telephone);
						$(".qq").text(data.qq);
						$(".email").text(data.email);
					},
					"error":function(xhr, status, errMsg){
			            console.log("é”™è¯¯:"+errMsg);
			        }
				})
			} else {
				$(".alert").show("slow");
			}
		}
		$(".updatePassword").click(function(){
			$(".old").val("");
			$(".new").val("");
			$(".password_box").show("slow");
			$(".cancle").click(function(){
				$(".password_box").hide("slow");
			});
		});
		// ç¡®è®¤ä¿®æ”¹å¯†ç 
		$(".submit").click(function(){
			var regPsd = /^[\w~!@#$%^&*()+{}[\]:"|',.?\-/]{6,16}$/;
			var str = $(".old").val() + "&" + $(".new").val();
			if (regPsd.test($(".new").val())) {
				modifyRequest("password",str);
			} else {
				$(".alertTip").text("å¯†ç è¾“å…¥ä¸åˆæ³•");
				$(".alertTip").show(function(){
					setTimeout(function(){
						$(".alertTip").hide();
					},1000);
				});
			}
		});
		function back () {
			window.location.href = "./index.html";
		}
		// è·å–cookie
		function getCookie(key){
			var cookie = document.cookie;
			var reg = new RegExp("(\\s|^)"+key+"=([^;]*)(;|$)");
			var s = cookie.match(reg);
			return s?s[2]:"";
		}
	</script>
</body>
</html>





