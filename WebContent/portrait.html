<!-- <%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%> -->
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="shortcut icon" type="images/x-icon" href="images/title.ico">
<title>å¤´åƒä¸Šä¼ </title>
<link href="css/common.css" rel="stylesheet">
    <link href="css/portrait.css" rel="stylesheet">
    <link href="css/iconfont.css" rel="stylesheet">
    <script src="js/adaptation.js"></script>
    <script src="js/jquery-1.11.3.min.js" type="text/javascript"></script>
</head>
<body>
	<div class="main">
		<div class="header">
	       <span style="position:absolute;left:10px;" onclick='window.location.href="./information.html"'><i class="iconfont icon-fanhui1" style="font-size:20px;"></i></span>
	       <p class="title">å¤´åƒä¸Šä¼ </p>
	    </div>
		<div class="box">
			<div class="pic">
				<p>
					<img alt="" src="" id="head_img">
				</p>
			</div>
			<div class="btn">
				<div class="up_btn">
					<input type="file" id="file" />
					<label for="file">é€‰æ‹©å›¾ç‰‡</label>
				</div>
				<button class="confirm" onclick="confirm()">ç¡®è®¤å¤´åƒ</button>
			</div>
		</div>
		<div class="alertTip">ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>
		<div class="alert">
	      	<p class="text">æ€ä¹ˆä¸ç™»å½•å°±è¿›æ¥äº†å‘¢ï¼Œèµ¶å¿«å»ç™»å½•ï¼Œä¹–ğŸ˜Šï½ï½ï½</p>
	      	<p class="btn" onclick="window.location.href='./login.html'">å»ç™»å½•</p>
        </div>
	</div>
	<script type="text/javascript">
		var input = document.getElementById("file"); 
		var img = document.getElementById("head_img");
		var baseData = "";
		if(typeof FileReader==='undefined'){ 
		     // "æŠ±æ­‰ï¼Œä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ FileReader"; 
		     input.setAttribute('disabled','disabled'); 
		}else{
		     input.addEventListener('change',readFile,false); 
		}
		function readFile () {
			var file = this.files[0];
			if (!/image\/\w+/.test(file.type)) { // åˆ¤æ–­æ˜¯å¦æ˜¯å›¾ç‰‡ åªå…è®¸å›¾ç‰‡ä¸Šä¼ 
				$(".alertTip").text("æ–‡ä»¶å¿…é¡»ä¸ºå›¾ç‰‡ï¼");
	  			  $(".alertTip").show(function(){
	  				  setTimeout(function(){
	  					$(".alertTip").hide();
	  				  },2000);
	  			})
		        return false; 
			}
			/* var blob = new Blob([file]); // æŠŠæ–‡ä»¶è½¬æ¢æˆblobå¯¹è±¡
			var url = window.URL.createObjectURL(blob); // é€šè¿‡urlä»å†…å­˜ä¸­è¯»å–url
			img.src = url; */
			var reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function (e) {
				baseData = this.result.split(',')[1];
				console.log(this.result);
				img.src = this.result;
			}
		}
		// è·å–ç”¨æˆ·ä¿¡æ¯
		getUserInfo();
		function getUserInfo () {
			var userName = getCookie("userName");
			if (!userName) {
				$(".alert").show("slow");
			}
			console.log("åˆå§‹åŒ–:"+userName);
			if (userName) {
				$.ajax({
					"async": false,
					"url": "/music/getUserInfo",
					"data": {"userName":userName},
					"type": "POST",
					"dataType": "json",
					"success": function (data) {
						console.log(img);
						img.src = data.portrait;
					},
					"error":function(xhr, status, errMsg){
			            console.log("é”™è¯¯:"+errMsg);
			        }
				})
			}
		}
		// ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
		function confirm () {
			var url = img.src;
			var userName = getCookie("userName");
			$.ajax({
				"async": false,
				"url": "/music/uploadPortrait",
				"data": {"head_imgurl": baseData,"userName":userName},
				"type": "POST",
				"success": function (data) {
					if (data == "true") {
						console.log(data);
						// åŒæ­¥ä¿®æ”¹æ­Œæ›²è¯„è®ºé‡Œçš„å¤´åƒ
						// updateCommentPortrait(userName);
						window.location.href = "./index.html";
					} else {
						// alert("ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
						$(".alertTip").text("ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
			  			  $(".alertTip").show(function(){
			  				  setTimeout(function(){
			  					$(".alertTip").hide();
			  				  },2000);
			  			})
					}
					console.log(data);
				},
				"error":function(xhr, status, errMsg){
		            console.log("é”™è¯¯:"+errMsg);
		        }
			})
		}
		// ä¿®æ”¹è¯„è®ºå¤´åƒ
		/* function updateCommentPortrait() {
			$.ajax({
  				"async": false,
  				"url": "${pageContext.request.contextPath }/updateCommentPortrait",
  				"data": {"portrait":portrait,"uid":uid},
  				"type": "POST",
  				"success": function (data) {
  					console.log("è¿”å›æ•°æ®ï¼š",data);
  				},
  				"error":function(xhr, status, errMsg){
  		            console.log("é”™è¯¯:"+errMsg);
  		        }
  			})
		} */
		// è·å–cookie
		function getCookie(key){
			var cookie = document.cookie;
			var reg = new RegExp("(\\s|^)"+key+"=([^;]*)(;|$)");
			var s = cookie.match(reg);
			return s?s[2]:"";
		}
	</script>
</body>










</html>